# Implementation Plan: User Registration

## 1. Overview of the Approach

This plan outlines the steps to add a user registration feature to the Express.js application. The approach involves creating a new API endpoint for registration, securely handling user passwords by hashing them, and storing user data. We will use the `bcrypt` library for password hashing, a standard and secure choice.

## 2. Step-by-Step Implementation Guide

### Step 1: Install Dependencies

We need to add the `bcrypt` library to handle password hashing.

```bash
npm install bcrypt
```

This will update the `package.json` file and install the necessary package.

### Step 2: Create a User Model

We'll define a simple user model to represent the user data structure. For now, we'll store users in memory, but this can be replaced with a database later.

**Create new file:** `src/models/user.js`

```javascript
// For now, we'll use a simple in-memory store for users.
// In a real application, you would use a database.
const users = [];

class User {
  constructor(username, password) {
    this.username = username;
    this.password = password;
  }

  static findByUsername(username) {
    return users.find(user => user.username === username);
  }

  save() {
    users.push(this);
  }
}

module.exports = User;
```

### Step 3: Add the Registration Route

We will add a new `/register` endpoint to the existing `src/routes/auth.js` file.

**Modify file:** `src/routes/auth.js`

```javascript
const express = require('express');
const router = express.Router();
const bcrypt = require('bcrypt');
const User = require('../models/user');

router.post('/login', (req, res) => {
  // Login logic
  res.json({ token: 'fake-jwt-token' });
});

router.post('/register', async (req, res) => {
  try {
    const { username, password } = req.body;

    // Basic input validation
    if (!username || !password) {
      return res.status(400).json({ error: 'Username and password are required' });
    }

    // Check if user already exists
    if (User.findByUsername(username)) {
      return res.status(409).json({ error: 'User already exists' });
    }

    // Hash the password
    const hashedPassword = await bcrypt.hash(password, 10);

    // Create and save the new user
    const newUser = new User(username, hashedPassword);
    newUser.save();

    res.status(201).json({ message: 'User registered successfully' });
  } catch (error) {
    res.status(500).json({ error: 'Internal server error' });
  }
});

module.exports = router;
```

### Step 4: Update the Main Application File

We need to ensure the main application file is using the auth routes. Let's assume the main file is `src/index.js` and add the auth routes to it.

**Create new file (if it doesn't exist):** `src/index.js`

```javascript
const express = require('express');
const authRouter = require('./routes/auth');

const app = express();
const port = 3000;

app.use(express.json());
app.use('/auth', authRouter);

app.listen(port, () => {
  console.log(`Server listening at http://localhost:${port}`);
});
```

## 3. Files to be Modified or Created

- **`package.json`**: Modified to add the `bcrypt` dependency.
- **`src/models/user.js`**: New file to define the user model.
- **`src/routes/auth.js`**: Modified to add the `/register` route.
- **`src/index.js`**: New file (or existing main file) to use the auth routes.

## 4. Testing Approach and Test Cases

We will use an API testing tool like Postman or `curl` to test the new endpoint.

### Test Cases:

1.  **Successful Registration:**
    -   **Request:** `POST /auth/register` with a unique username and a password.
    -   **Expected Response:** `201 Created` with a success message.

2.  **Missing Username or Password:**
    -   **Request:** `POST /auth/register` with a missing `username` or `password`.
    -   **Expected Response:** `400 Bad Request` with an error message.

3.  **Duplicate Username:**
    -   **Request:** `POST /auth/register` with a username that already exists.
    -   **Expected Response:** `409 Conflict` with an error message.

## 5. Potential Challenges and Solutions

-   **In-Memory Storage:** The current implementation uses an in-memory array to store users, which is not persistent.
    -   **Solution:** For a production environment, this should be replaced with a database like MongoDB or PostgreSQL.
-   **Input Validation:** The current validation is very basic.
    -   **Solution:** Implement more robust validation using a library like `joi` or `express-validator` to check for password strength, username format, etc.

## 6. Verification Steps

1.  Run `npm install` to ensure all dependencies are installed correctly.
2.  Start the server with `node src/index.js`.
3.  Use `curl` or Postman to send a `POST` request to `http://localhost:3000/auth/register` with a JSON body like `{"username": "testuser", "password": "password123"}`.
4.  Verify that the response is a `201 Created`.
5.  Send the same request again and verify that the response is a `409 Conflict`.
6.  Send a request with a missing password and verify that the response is a `400 Bad Request`.
